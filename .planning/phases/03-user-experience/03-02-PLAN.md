---
phase: 03-user-experience
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/orchestrator/pipeline.ts
  - test/orchestrator/pipeline.test.ts
  - test/integration/pipeline.integration.test.ts
autonomous: true

must_haves:
  truths:
    - "Pipeline passes structured alternatives and file context to ConsentManager when prompting for approval"
    - "When user selects a built-in alternative, pipeline triggers coder retry with feedback to use the alternative module"
    - "When user selects a built-in alternative, the package is NOT installed"
    - "File context from packageFileMap is passed through to consent prompt so user sees which files need the package"
    - "Pipeline correctly handles mixed results: some packages approved, some alternatives selected, some rejected"
  artifacts:
    - path: "src/orchestrator/pipeline.ts"
      provides: "Integrated alternative selection flow with coder retry and file context display"
      contains: "checkBatchApprovalWithAlternatives"
    - path: "test/orchestrator/pipeline.test.ts"
      provides: "Unit tests for alternative selection flow in pipeline"
    - path: "test/integration/pipeline.integration.test.ts"
      provides: "Integration tests for end-to-end alternative flow"
  key_links:
    - from: "src/orchestrator/pipeline.ts"
      to: "src/consent/manager.ts"
      via: "Calls checkBatchApprovalWithAlternatives instead of checkBatchApproval"
      pattern: "checkBatchApprovalWithAlternatives"
    - from: "src/orchestrator/pipeline.ts"
      to: "src/tools/importValidator.ts"
      via: "Reads alternatives from validate() result to pass to consent"
      pattern: "result\\.alternatives"
    - from: "src/orchestrator/pipeline.ts"
      to: "src/agents/coder.ts"
      via: "Sends importValidationFeedback with alternative module instructions on coder retry"
      pattern: "importValidationFeedback.*alternative"
---

<objective>
Wire structured alternatives and file context through the pipeline's import validation loop. When a user selects a built-in alternative instead of installing a package, trigger a coder retry with explicit instructions to rewrite using the alternative module.

Purpose: This completes INST-03 (agent offers built-in alternatives) and INST-04 (user can choose alternative) by connecting the enhanced consent flow (plan 01) to the pipeline execution loop.

Output: Updated pipeline.ts with full alternative selection flow and comprehensive tests.
</objective>

<execution_context>
@/home/reset/.claude/get-shit-done/workflows/execute-plan.md
@/home/reset/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-user-experience/03-RESEARCH.md
@.planning/phases/03-user-experience/03-01-SUMMARY.md

@src/orchestrator/pipeline.ts
@src/tools/importValidator.ts
@src/consent/manager.ts
@src/consent/prompter.ts
@test/orchestrator/pipeline.test.ts
@test/integration/pipeline.integration.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire structured alternatives and file context into pipeline consent flow</name>
  <files>src/orchestrator/pipeline.ts</files>
  <action>
In the pipeline's import validation loop (around lines 182-382), make these changes:

1. **Collect structured alternatives during validation:** When calling `importValidator.validate(change.content)`, the result now includes `alternatives: Map<string, AlternativeInfo>`. Collect these into an aggregate `allAlternatives: Map<string, AlternativeInfo>` alongside the existing `allMissing` and `allSuggestions`.

2. **Switch from checkBatchApproval to checkBatchApprovalWithAlternatives:** When consent is needed (the `else if (options.consentManager)` branch around line 240), replace:
```typescript
approved = await options.consentManager.checkBatchApproval(
  registryValid,
  { suggestedAlternatives: [`Install command: ${installCmd}`] }
)
```
with:
```typescript
const batchResult = await options.consentManager.checkBatchApprovalWithAlternatives(
  registryValid,
  {
    alternatives: allAlternatives,  // Structured AlternativeInfo from ImportValidator
    fileContext: packageFileMap,     // Already exists: Map<string, string[]>
  }
)
approved = batchResult.approved
rejected = [...batchResult.rejected]
const selectedAlternatives = batchResult.alternatives  // Map<string, string>: pkg -> module
```

3. **Handle alternative selections:** After the consent call, if `selectedAlternatives.size > 0`, build feedback for coder retry. For each alternative selection:
```typescript
const altFeedbackLines: string[] = []
for (const [pkg, altModule] of selectedAlternatives) {
  const altInfo = allAlternatives.get(pkg)
  altFeedbackLines.push(
    `User chose built-in alternative for "${pkg}". Replace all imports of "${pkg}" with "${altModule}".`
  )
  if (altInfo?.example) {
    altFeedbackLines.push(`  Example: ${altInfo.example}`)
  }
}
```

4. **Trigger coder retry for alternatives:** If there are alternative selections, the coder needs to rewrite. Send feedback and re-run coder:
```typescript
if (altFeedbackLines.length > 0) {
  // Remove alternative packages from the "needs installation" list
  // They don't need installation, coder will rewrite to use built-in
  const needsInstall = approved  // Only truly approved packages get installed

  // Retry coder with alternative instructions
  codeResult = await coderAgent(
    { ...coderInput, importValidationFeedback: altFeedbackLines.join('\n') },
    createAgentContext('coder')
  )
  if (!codeResult.ok) {
    errors.push(`Coder alternative-rewrite failed for task ${task.id}: ${codeResult.error.message}`)
    break
  }
}
```

5. **Preserve existing flows:** The auto-install path (`options.autoInstall`) remains unchanged -- it doesn't prompt and doesn't offer alternatives. The no-PM path also remains unchanged. The registry-invalid + rejected feedback path should also include alternative packages in its "unresolvable" set only if the coder retry failed, not for successfully handled alternatives.

6. **Order of operations:** After consent:
   a. Install approved packages (existing flow, unchanged)
   b. Retry coder for alternatives (new)
   c. Retry coder for unresolvable packages (existing, but exclude alternatives from unresolvable list)
   d. Re-validate after all retries

Key consideration: Do NOT count alternative-selected packages as "approved" or "rejected" -- they are a third category. The package should be removed from `allMissing` after successful coder rewrite (the re-validation loop handles this naturally).
  </action>
  <verify>npx tsc --noEmit -- TypeScript compiles with pipeline changes</verify>
  <done>Pipeline calls checkBatchApprovalWithAlternatives, passes structured alternatives and file context, handles alternative selections by triggering coder retry with module replacement instructions, and does not install packages the user chose alternatives for.</done>
</task>

<task type="auto">
  <name>Task 2: Tests for pipeline alternative selection flow</name>
  <files>test/orchestrator/pipeline.test.ts, test/integration/pipeline.integration.test.ts</files>
  <action>
Add tests covering the alternative selection flow in the pipeline.

**Unit tests in pipeline.test.ts:**

1. **Test: alternative selection triggers coder retry with feedback**
   - Mock ImportValidator.validate() to return missingPackages with alternatives.
   - Mock ConsentManager.checkBatchApprovalWithAlternatives() to return `{ approved: [], alternatives: new Map([['uuid', 'node:crypto']]), rejected: [] }`.
   - Verify coderAgent is called again with importValidationFeedback containing "Replace all imports of \"uuid\" with \"node:crypto\"".
   - Verify installPackages is NOT called for uuid.

2. **Test: mixed consent results (some install, some alternative)**
   - Two missing packages: axios and uuid.
   - Mock consent: approved=['axios'], alternatives=Map([['uuid', 'node:crypto']]), rejected=[].
   - Verify axios is installed via installPackages.
   - Verify coder retry includes feedback about uuid -> node:crypto.
   - Verify uuid is NOT passed to installPackages.

3. **Test: file context is passed to checkBatchApprovalWithAlternatives**
   - Mock coder output with two files importing axios.
   - Verify checkBatchApprovalWithAlternatives is called with fileContext containing the file paths.

4. **Test: structured alternatives from validate() passed to consent**
   - Mock ImportValidator.validate() to return alternatives Map with AlternativeInfo for axios.
   - Verify checkBatchApprovalWithAlternatives receives the alternatives Map.

5. **Test: auto-install mode bypasses alternative selection**
   - Set options.autoInstall = true.
   - Verify checkBatchApprovalWithAlternatives is NOT called.
   - Verify packages are installed directly (existing behavior).

**Integration tests in pipeline.integration.test.ts:**

6. **Test: end-to-end alternative selection flow**
   - Full pipeline run with mock LLM returning code that imports uuid.
   - ConsentManager configured to select alternative (node:crypto).
   - Mock coder retry to return code using node:crypto instead.
   - Verify pipeline succeeds without installing uuid.

Run: `npx vitest run test/orchestrator/pipeline.test.ts test/integration/pipeline.integration.test.ts`
  </action>
  <verify>npx vitest run test/orchestrator/pipeline.test.ts test/integration/pipeline.integration.test.ts -- all tests pass</verify>
  <done>Pipeline alternative flow fully tested: alternative selection triggers coder retry, file context passed through, mixed results handled, auto-install unaffected. All existing pipeline tests still pass.</done>
</task>

</tasks>

<verification>
```bash
# Pipeline tests pass
npx vitest run test/orchestrator/pipeline.test.ts test/integration/pipeline.integration.test.ts

# All project tests pass
npx vitest run

# TypeScript compiles
npx tsc --noEmit
```
</verification>

<success_criteria>
1. Pipeline uses checkBatchApprovalWithAlternatives with structured alternatives and file context
2. Alternative selection triggers coder retry with explicit module replacement instructions
3. Packages with selected alternatives are NOT installed
4. Mixed results (install + alternative + reject) handled correctly
5. Auto-install mode unchanged (no alternative prompting)
6. File context from packageFileMap displayed in consent prompt
7. All tests pass including new pipeline and integration tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-experience/03-02-SUMMARY.md`
</output>

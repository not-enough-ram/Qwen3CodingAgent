---
phase: 01-ecosystem-detection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tools/packageManager.ts
  - test/tools/packageManager.test.ts
  - src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "Detector returns 'pnpm' when pnpm-lock.yaml exists"
    - "Detector returns 'npm' when package-lock.json exists"
    - "Detector returns 'yarn' when yarn.lock exists"
    - "Detector returns error with list of found PMs when multiple lock files exist"
    - "Detector returns PM from package.json packageManager field when no lock file exists"
    - "Detector defaults to 'npm' when no lock file and no packageManager field"
  artifacts:
    - path: "src/tools/packageManager.ts"
      provides: "PackageManagerDetector with detect() method"
      exports: ["detectPackageManager", "PackageManager", "DetectionResult", "DetectionError"]
    - path: "test/tools/packageManager.test.ts"
      provides: "Full test coverage for detection logic"
      contains: "describe.*PackageManager"
  key_links:
    - from: "src/tools/packageManager.ts"
      to: "node:fs"
      via: "existsSync for lock file checks"
      pattern: "existsSync.*lock"
    - from: "src/tools/packageManager.ts"
      to: "node:fs"
      via: "readFileSync for package.json packageManager field"
      pattern: "readFileSync.*package\\.json"
---

<objective>
Implement package manager detection from lock files and package.json with full test coverage using TDD.

Purpose: DEP-01 requires the agent to auto-detect which package manager (npm/pnpm/yarn) a project uses. This is the foundation for all installation commands in later plans.
Output: `src/tools/packageManager.ts` with `detectPackageManager()` function and comprehensive tests.
</objective>

<execution_context>
@/home/reset/.claude/get-shit-done/workflows/execute-plan.md
@/home/reset/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/tools/toolkit.ts
@src/utils/result.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement PackageManagerDetector with TDD</name>
  <files>src/tools/packageManager.ts, test/tools/packageManager.test.ts</files>
  <action>
**TDD: RED phase first, then GREEN.**

Create `test/tools/packageManager.test.ts` with tests covering all detection scenarios. Use a temp directory (via `node:fs mkdtempSync`) for each test to create/remove lock files.

Test cases (write ALL tests first, they must FAIL):
1. Returns `ok('pnpm')` when only `pnpm-lock.yaml` exists in project root
2. Returns `ok('npm')` when only `package-lock.json` exists in project root
3. Returns `ok('yarn')` when only `yarn.lock` exists in project root
4. Returns `err({ type: 'multiple_lock_files', found: ['pnpm', 'npm'] })` when both `pnpm-lock.yaml` and `package-lock.json` exist (user decision: prompt user to choose)
5. Returns `ok('pnpm')` when no lock file but `package.json` has `"packageManager": "pnpm@8.6.0"` (corepack support per user decision)
6. Returns `ok('npm')` when no lock file but `package.json` has `"packageManager": "npm@10.0.0+sha224.abc123"` (with hash)
7. Returns `ok('yarn')` when no lock file but `package.json` has `"packageManager": "yarn@4.0.0"`
8. Returns `ok('npm')` when no lock file and no `packageManager` field (user decision: default to npm)
9. Returns `ok('npm')` when no lock file and no `package.json` exists (default to npm)
10. Lock file detection takes priority over `packageManager` field (lock file is ground truth)
11. Returns error when 3 lock files exist (all three PMs detected)

Then create `src/tools/packageManager.ts`:

```typescript
import { existsSync, readFileSync } from 'node:fs'
import { join } from 'node:path'
import { type Result, ok, err } from '../utils/result.js'

export type PackageManager = 'npm' | 'pnpm' | 'yarn'

export type DetectionError = {
  type: 'multiple_lock_files'
  found: PackageManager[]
  message: string
}

export type DetectionResult = Result<PackageManager, DetectionError>
```

The `detectPackageManager(projectRoot: string): DetectionResult` function must:
1. Check for lock files: `pnpm-lock.yaml` -> pnpm, `package-lock.json` -> npm, `yarn.lock` -> yarn (per user decision: check lock files FIRST)
2. If multiple lock files found, return `err({ type: 'multiple_lock_files', found, message })` (per user decision: prompt user to choose)
3. If exactly one lock file found, return `ok(pm)`
4. If no lock file, check `package.json` `packageManager` field (per user decision: corepack support)
5. Parse field format: `"pnpm@8.6.0"` or `"npm@9.0.0+sha224.abc123"` - extract PM name before `@`
6. If no lock file and no packageManager field, return `ok('npm')` (per user decision: default to npm)

Use the existing `Result<T, E>` pattern from `src/utils/result.ts`. Do NOT use classes - export a plain function `detectPackageManager`.
  </action>
  <verify>
Run `pnpm vitest run test/tools/packageManager.test.ts` — all tests pass. Verify test count matches expected (at least 11 test cases).
  </verify>
  <done>
`detectPackageManager()` correctly identifies package manager from lock files, falls back to package.json packageManager field, and defaults to npm. All test cases pass. Multiple lock files return an error with the list of found PMs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export PackageManagerDetector from tools index</name>
  <files>src/tools/index.ts</files>
  <action>
Add `export * from './packageManager.js'` to `src/tools/index.ts`.

Verify the export doesn't conflict with existing exports by checking `src/tools/index.ts` current exports.

Run TypeScript compilation to ensure no import/export conflicts.
  </action>
  <verify>
Run `pnpm tsc --noEmit` — no type errors. Run `pnpm vitest run test/tools/packageManager.test.ts` — still passes.
  </verify>
  <done>
`PackageManager`, `DetectionResult`, `DetectionError`, and `detectPackageManager` are importable from `src/tools/index.ts`. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run test/tools/packageManager.test.ts` — all tests pass
2. `pnpm tsc --noEmit` — no type errors
3. Tests cover: single lock file (3 PMs), multiple lock files, packageManager field (3 formats), no lock file default, priority order
</verification>

<success_criteria>
- detectPackageManager() returns correct PM for each lock file type
- Multiple lock files produce an error result (not silently picking one)
- package.json packageManager field is checked as fallback
- npm is the default when nothing is detected
- All tests pass, TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/01-ecosystem-detection/01-01-SUMMARY.md`
</output>

---
phase: 02-dependency-analysis
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/tools/dependencyCategorizer.ts
  - src/tools/packageInstaller.ts
  - test/tools/dependencyCategorizer.test.ts
  - test/tools/packageInstaller.test.ts
autonomous: true

must_haves:
  truths:
    - "Test files (*.test.ts, *.spec.ts, __tests__/*) cause packages to be categorized as dev"
    - "@types/* packages are always categorized as dev regardless of importing file"
    - "Known dev-only packages (vitest, jest, eslint, etc.) are categorized as dev"
    - "Packages imported in ANY non-test file are categorized as production even if also in test files"
    - "buildInstallArgs produces --save-dev/-D/--dev flags for dev category packages"
  artifacts:
    - path: "src/tools/dependencyCategorizer.ts"
      provides: "isTestFile(), categorizePackage(), categorizePackages() functions"
      exports: ["isTestFile", "categorizePackage", "categorizePackages", "CategorizedPackages"]
    - path: "src/tools/packageInstaller.ts"
      provides: "Updated buildInstallArgs with category parameter"
      exports: ["buildInstallArgs", "installPackages"]
    - path: "test/tools/dependencyCategorizer.test.ts"
      provides: "Full test coverage for categorization logic"
      contains: "describe.*categorize"
    - path: "test/tools/packageInstaller.test.ts"
      provides: "Updated tests for dev install args"
      contains: "save-dev"
  key_links:
    - from: "src/tools/dependencyCategorizer.ts"
      to: "src/tools/packageInstaller.ts"
      via: "CategorizedPackages type used by buildInstallArgs"
      pattern: "CategorizedPackages"
---

<objective>
Implement dependency categorization logic (DEP-03) that determines whether packages should be installed as production or dev dependencies based on usage context, and update the install command builder to support --save-dev flags.

Purpose: When the agent installs missing packages, test-only packages (vitest, @types/node) should go to devDependencies while production packages (zod, express) go to dependencies. This prevents test tooling from inflating production bundles.

Output: Tested categorization module + updated package installer with dev dependency support.
</objective>

<execution_context>
@/home/reset/.claude/get-shit-done/workflows/execute-plan.md
@/home/reset/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-dependency-analysis/02-RESEARCH.md
@src/tools/packageInstaller.ts
@test/tools/packageInstaller.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD — Dependency categorizer with test file detection</name>
  <files>
    src/tools/dependencyCategorizer.ts
    test/tools/dependencyCategorizer.test.ts
  </files>
  <action>
**RED phase:** Create `test/tools/dependencyCategorizer.test.ts` with failing tests covering:

1. `isTestFile(filePath)` — returns true for:
   - `src/foo.test.ts`, `src/foo.spec.ts` (vitest/jest patterns)
   - `src/foo.test.js`, `src/foo.spec.jsx`, `src/foo.test.mts` (all JS extensions)
   - `__tests__/foo.ts` (jest __tests__ directory)
   - `test/foo.ts`, `tests/foo.ts`, `spec/foo.ts` (mocha/generic patterns)
   - `src/foo-test.ts`, `src/foo-spec.ts` (dash variants)
   Returns false for:
   - `src/foo.ts`, `src/utils/helper.js` (production files)
   - `src/testUtils.ts` (contains "test" but not a test file pattern)
   - `src/contest.ts` (contains "test" substring but not a test pattern)

2. `categorizePackage(packageName, importingFilePaths)` — returns `'dev'` or `'prod'`:
   - `('vitest', ['test/setup.ts'])` → `'dev'` (known dev package + test file)
   - `('vitest', ['src/main.ts'])` → `'dev'` (known dev package always dev, even in prod file)
   - `('@types/node', ['src/server.ts'])` → `'dev'` (@types always dev)
   - `('@types/express', ['test/app.test.ts'])` → `'dev'` (@types always dev)
   - `('zod', ['test/user.test.ts'])` → `'dev'` (only in test files)
   - `('zod', ['src/user.ts', 'test/user.test.ts'])` → `'prod'` (used in prod file too)
   - `('express', ['src/server.ts'])` → `'prod'` (production file)
   - `('eslint', ['src/lint.ts'])` → `'dev'` (known dev package)
   - `('jest', ['.config/jest.config.ts'])` → `'dev'` (known dev package)
   - `('typescript', ['scripts/build.ts'])` → `'dev'` (known dev package)
   - `('prettier', ['src/format.ts'])` → `'dev'` (known dev package)
   - `('unknown-pkg', ['src/app.ts'])` → `'prod'` (default to prod for unknown)

3. `categorizePackages(entries)` — batch categorization:
   - Input: `[{name: 'zod', files: ['src/user.ts']}, {name: 'vitest', files: ['test/setup.ts']}]`
   - Output: `{ production: ['zod'], dev: ['vitest'] }`

**GREEN phase:** Create `src/tools/dependencyCategorizer.ts` with minimal implementation:

```typescript
export type CategorizedPackages = { production: string[]; dev: string[] }
export type PackageEntry = { name: string; files: string[] }

export function isTestFile(filePath: string): boolean { ... }
export function categorizePackage(packageName: string, importingFilePaths: string[]): 'dev' | 'prod' { ... }
export function categorizePackages(entries: PackageEntry[]): CategorizedPackages { ... }
```

Known dev-only packages list (from research): `vitest`, `jest`, `mocha`, `chai`, `jasmine`, `eslint`, `prettier`, `husky`, `lint-staged`, `typescript`, `ts-node`, `ts-jest`, `webpack`, `vite`, `rollup`, `esbuild`, `nodemon`, `concurrently`.

Test file patterns (from research): `.test.{ext}`, `.spec.{ext}`, `__tests__/`, `/test/`, `/tests/`, `/spec/`, `/specs/`, `-test.{ext}`, `-spec.{ext}`. Extensions: `ts|js|tsx|jsx|mts|cts|mjs|cjs`.

Categorization priority:
1. @types/* → always dev
2. Known dev packages → always dev
3. All importing files are test files → dev
4. Any non-test importing file → prod
5. Default (no file context) → prod

**REFACTOR phase:** Clean up if needed, ensure no duplication.
  </action>
  <verify>Run `npx vitest run test/tools/dependencyCategorizer.test.ts` — all tests pass. RED phase commits should show failing tests, GREEN phase commits show passing.</verify>
  <done>isTestFile detects all major test file patterns. categorizePackage correctly prioritizes known-dev > @types > file-context > default-prod. categorizePackages batches correctly into {production, dev} groups. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Update buildInstallArgs to support dev category</name>
  <files>
    src/tools/packageInstaller.ts
    test/tools/packageInstaller.test.ts
  </files>
  <action>
**RED phase:** Add failing tests to `test/tools/packageInstaller.test.ts`:

1. `buildInstallArgs('npm', ['vitest'], 'dev')` → `['install', '--save-dev', 'vitest']`
2. `buildInstallArgs('pnpm', ['vitest'], 'dev')` → `['add', '-D', 'vitest']`
3. `buildInstallArgs('yarn', ['vitest'], 'dev')` → `['add', '--dev', 'vitest']`
4. `buildInstallArgs('npm', ['zod'], 'prod')` → `['install', '--save', 'zod']` (existing behavior)
5. `buildInstallArgs('npm', ['zod'])` → `['install', '--save', 'zod']` (backward compatible — no category defaults to prod)
6. `buildInstallArgs('pnpm', ['@types/node', 'vitest'], 'dev')` → `['add', '-D', '@types/node', 'vitest']` (multiple dev packages)

**GREEN phase:** Update `buildInstallArgs` signature in `src/tools/packageInstaller.ts`:

```typescript
export function buildInstallArgs(
  pm: PackageManager,
  packages: string[],
  category: 'dev' | 'prod' = 'prod'
): string[]
```

Add dev flag logic per PM:
- npm: `--save-dev` for dev, `--save` for prod (existing)
- pnpm: `-D` for dev, nothing extra for prod (existing)
- yarn: `--dev` for dev, nothing extra for prod (existing)

The third parameter defaults to `'prod'` so existing callers are unaffected (backward compatible).

**REFACTOR phase:** Existing tests should still pass unchanged since default is `'prod'`.
  </action>
  <verify>Run `npx vitest run test/tools/packageInstaller.test.ts` — all tests pass including new dev-category tests AND existing prod tests (unchanged behavior).</verify>
  <done>buildInstallArgs accepts optional category parameter. Dev packages get --save-dev (npm), -D (pnpm), --dev (yarn). Existing callers unchanged (default to prod). All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run test/tools/dependencyCategorizer.test.ts` — all categorization tests pass
2. `npx vitest run test/tools/packageInstaller.test.ts` — all install args tests pass (new dev + existing prod)
3. `npx vitest run` — full suite passes (no regressions)
4. TypeScript compiles: `npx tsc --noEmit`
</verification>

<success_criteria>
- categorizePackage() correctly identifies dev vs prod for all test cases
- isTestFile() covers vitest, jest, mocha, and generic test file patterns
- @types/* always categorized as dev regardless of context
- Known dev packages (vitest, jest, eslint, etc.) always categorized as dev
- buildInstallArgs produces correct flags for dev dependencies across npm/pnpm/yarn
- Backward compatible — existing callers unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/02-dependency-analysis/02-01-SUMMARY.md`
</output>
